<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Escalas Médicas (Offline)</title>
    <style>
        /* Reset e Configurações Globais */
        :root {
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-100: #dbeafe;
            --blue-800: #1e40af;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --white: #ffffff;
            --black: #000000;
            --red-200: #fecaca;
            --red-600: #dc2626;
            --green-600: #16a34a;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--gray-100);
            margin: 0;
        }

        /* Estilos da Tela de Login */
        #login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--gray-200);
        }
        .login-container {
            width: 100%;
            max-width: 28rem;
            padding: 2rem;
            background-color: var(--white);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .login-container .text-center {
            text-align: center;
        }
        .login-container h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-800);
        }
        .login-container p {
            margin-top: 0.5rem;
            color: var(--gray-600);
        }
        .login-buttons {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .login-buttons button {
            width: 100%;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .login-buttons button:hover {
            transform: scale(1.05);
        }
        .btn-gestor {
            color: var(--white);
            background-color: var(--blue-600);
        }
        .btn-gestor:hover {
            background-color: var(--blue-700);
        }
        .btn-colaborador {
            color: var(--gray-700);
            background-color: var(--gray-200);
        }
        .btn-colaborador:hover {
            background-color: var(--gray-300);
        }
        .login-footer {
            font-size: 0.75rem;
            text-align: center;
            color: var(--gray-500);
            margin-top: 2rem;
        }

        /* Estilos da Aplicação Principal */
        .app-container {
            display: flex;
            height: 100vh;
            background-color: var(--gray-50);
        }
        .sidebar {
            width: 20rem;
            background-color: var(--white);
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }
        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
        }
        .sidebar-header p {
            font-size: 0.875rem;
            color: var(--gray-500);
        }
        .sidebar-filter {
            padding: 1rem;
        }
        .sidebar-filter select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
        }
        #doctors-panel {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #remove-zone {
            padding: 1rem;
            border-top: 1px dashed var(--gray-300);
            text-align: center;
            color: var(--gray-500);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-200);
            flex-shrink: 0;
        }
        .main-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-controls .filter-group, .header-controls .nav-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .header-controls label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }
        .header-controls select, .header-controls button {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            background-color: var(--gray-200);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .header-controls button:hover {
            background-color: var(--gray-300);
        }
        
        /* Abas de Navegação */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            background-color: var(--white);
            padding: 0 1rem;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-500);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: var(--blue-600);
            border-bottom-color: var(--blue-600);
        }
        .tab-content {
            padding: 1rem;
            overflow: auto;
            flex: 1;
        }
        
        .schedule-container {
            overflow: auto;
        }
        #schedule-grid {
            background-color: var(--white);
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            display: grid;
            grid-template-columns: 150px 150px repeat(6, 1fr);
            gap: 4px;
        }
        .grid-header {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
        }
        .grid-header > div {
            padding: 0.5rem;
            font-weight: 700;
            color: var(--gray-600);
            font-size: 0.875rem;
            border-bottom: 2px solid var(--gray-200);
            text-align: center;
        }
        .grid-header > div:first-child, .grid-header > div:nth-child(2) {
            text-align: left;
        }
        .unit-header, .period-header {
            position: sticky;
            padding: 0.5rem;
            background-color: #f9fafb;
            border-right: 1px solid var(--gray-200);
            border-bottom: 1px solid var(--gray-200);
            font-weight: 600;
        }
        .unit-header { left: 0; z-index: 5; }
        .period-header { left: 150px; z-index: 5; }
        .period-header .period-text { font-size: 0.75rem; color: var(--gray-500); }

        /* Estilos de Drag and Drop */
        .draggable {
            cursor: move;
            transition: all 0.2s ease-in-out;
            background-color: var(--white);
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            border: 1px solid var(--gray-200);
        }
        .draggable:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .draggable p:first-child { font-weight: 600; color: var(--gray-800); }
        .draggable p:last-child { font-size: 0.875rem; color: var(--gray-500); }
        
        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .drop-zone {
            border-bottom: 1px solid var(--gray-200);
            border-right: 1px solid var(--gray-200);
            padding: 0.5rem;
            min-height: 100px;
            transition: all 0.2s ease;
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border-style: dashed;
        }
        .remove-zone.drag-over {
            background-color: var(--red-200);
            transform: scale(1.05);
        }
        .allocated-slot {
            background-color: var(--blue-100);
            padding: 0.5rem;
            border-radius: 0.375rem;
            height: 100%;
            color: var(--blue-800);
        }
        .allocated-slot p:first-child { font-weight: 700; font-size: 0.875rem; }
        .allocated-slot p:last-child { font-size: 0.75rem; }
        .empty-slot {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-300);
            font-size: 0.75rem;
        }

        /* Página de Cadastro e Gerenciamento de Dados */
        .data-management-section {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .data-management-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            box-sizing: border-box;
        }
        .data-management-section button, .data-management-section .btn {
            padding: 0.75rem;
            background-color: var(--blue-600);
            color: var(--white);
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
        }
        .data-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .data-actions .btn-export {
            background-color: var(--green-600);
        }
        .data-actions .btn-import {
            background-color: var(--gray-600);
        }
        .data-table-container {
            max-height: 400px;
            overflow: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--white);
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
        }
        .data-table th {
            background-color: #f9fafb;
            position: sticky;
            top: 0;
        }

        /* Gerenciamento de Unidades */
        #units-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .unit-card {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
        }
        .unit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .unit-card-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }
        .btn-remove {
            background: none;
            border: none;
            color: var(--red-600);
            cursor: pointer;
            padding: 0.25rem;
        }
        .room-list {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }
        .room-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .room-list-item:nth-child(odd) {
            background-color: var(--gray-50);
        }
        .add-room-form {
            display: flex;
            gap: 0.5rem;
        }
        .add-room-form input {
            flex: 1;
        }
        .add-room-form button {
            padding: 0.5rem;
        }


        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex; 
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--white);
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            padding: 1.5rem;
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        .modal-content h3 {
            margin-top: 0;
            font-size: 1.25rem;
        }
        .modal-content p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
        }
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: var(--blue-600);
            color: var(--white);
        }
        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-800);
        }
        .btn-danger {
            background-color: var(--red-600);
            color: var(--white);
        }
        .btn-cancel {
            background-color: transparent;
            color: var(--gray-600);
            border-color: var(--gray-300);
        }


        /* Ícones SVG */
        .icon {
            width: 1em;
            height: 1em;
            fill: currentColor;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }

        .hidden { display: none !important; }
        .contents { display: contents; }
    </style>
</head>
<body>

    <!-- Tela de Login -->
    <div id="login-page">
        <div class="login-container">
            <div class="text-center">
                <h2>Acesso ao Sistema</h2>
                <p>Selecione seu perfil para continuar</p>
            </div>
            <div class="login-buttons">
                <button id="login-gestor" class="btn-gestor">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3zM432 432a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>
                    Acessar como Gestor
                </button>
                <button id="login-colaborador" class="btn-colaborador">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>
                    Acessar como Colaborador
                </button>
            </div>
            <p class="login-footer">
                &copy;2024 CMK. Todos os direitos reservados.
            </p>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div id="app-page" class="hidden">
        <div class="app-container">
            <!-- Painel Lateral de Profissionais -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>Profissionais</h2>
                    <p>Arraste para alocar na grade</p>
                </div>
                <div class="sidebar-filter">
                     <select id="specialty-filter-sidebar">
                        <option value="all">Todas Especialidades</option>
                    </select>
                </div>
                <div id="doctors-panel">
                    <!-- Lista de médicos será populada pelo JS -->
                </div>
                <div id="remove-zone">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    Arraste aqui para remover
                </div>
            </aside>

            <!-- Conteúdo Principal -->
            <main class="main-content">
                <header class="main-header">
                    <div>
                        <h1 class="main-title">Painel de Gestão</h1>
                        <p id="current-week-display">Carregando semana...</p>
                    </div>
                    <div id="schedule-controls" class="header-controls">
                        <div class="filter-group">
                            <label for="unit-filter">Unidade:</label>
                            <select id="unit-filter">
                                <option value="all">Todas</option>
                            </select>
                        </div>
                        <div class="nav-group">
                            <button id="prev-week"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"/></svg></button>
                            <button id="next-week"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8-12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/></svg></button>
                        </div>
                    </div>
                </header>

                <div class="tabs">
                    <button class="tab-button active" data-tab="schedule-panel">Gestão de Escalas</button>
                    <button class="tab-button" data-tab="registration-panel">Cadastro de Profissionais</button>
                    <button class="tab-button" data-tab="data-panel">Gerenciar Dados</button>
                    <button class="tab-button" data-tab="units-panel">Gerenciar Unidades</button>
                </div>

                <div id="schedule-panel" class="tab-content">
                    <div class="schedule-container">
                        <div id="schedule-grid">
                            <!-- Conteúdo da grade será gerado pelo JS -->
                        </div>
                    </div>
                </div>

                <div id="registration-panel" class="tab-content hidden">
                    <div class="data-management-section">
                        <form id="registration-form">
                            <h3>Cadastrar Novo Profissional</h3>
                            <div class="form-group">
                                <label for="prof-name">Nome</label>
                                <input type="text" id="prof-name" required>
                            </div>
                            <div class="form-group">
                                <label for="prof-specialty">Especialidade</label>
                                <input type="text" id="prof-specialty" required>
                            </div>
                            <div class="form-group">
                                <label for="prof-phone">Telefone</label>
                                <input type="tel" id="prof-phone" placeholder="(21) 99999-9999">
                            </div>
                            <button type="submit">Adicionar Profissional</button>
                        </form>
                    </div>
                    <div class="data-management-section">
                        <h3>Profissionais Cadastrados</h3>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Especialidade</th>
                                        <th>Telefone</th>
                                    </tr>
                                </thead>
                                <tbody id="professionals-table-body">
                                    <!-- Lista de profissionais será populada pelo JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="data-panel" class="tab-content hidden">
                    <div class="data-management-section">
                        <h3>Gerenciamento de Dados da Escala</h3>
                        <div class="data-actions">
                            <button id="export-csv-btn" class="btn btn-export">Exportar para CSV</button>
                            <button id="import-csv-btn" class="btn btn-import">Importar CSV</button>
                            <input type="file" id="csv-import-input" class="hidden" accept=".csv">
                        </div>
                        <div class="data-table-container">
                             <table id="full-schedule-table" class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID da Escala</th>
                                        <th>ID Recorrente</th>
                                        <th>Data</th>
                                        <th>Unidade</th>
                                        <th>Sala</th>
                                        <th>Período</th>
                                        <th>Profissional</th>
                                        <th>Especialidade</th>
                                    </tr>
                                </thead>
                                <tbody id="full-schedule-table-body">
                                    <!-- Tabela completa da escala será populada pelo JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="units-panel" class="tab-content hidden">
                     <div class="data-management-section">
                        <form id="add-unit-form">
                            <h3>Adicionar Nova Unidade</h3>
                            <div class="form-group">
                                <label for="unit-name">Nome da Unidade</label>
                                <input type="text" id="unit-name" required>
                            </div>
                            <div class="form-group">
                                <label for="initial-room-name">Nome da Primeira Sala</label>
                                <input type="text" id="initial-room-name" required>
                            </div>
                            <button type="submit">Adicionar Unidade</button>
                        </form>
                    </div>
                    <div id="units-container">
                        <!-- Cards de unidades serão gerados pelo JS -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Notificação Simples -->
    <div id="notification-modal" class="modal hidden">
        <div class="modal-content">
            <p id="notification-message"></p>
            <button id="notification-close" class="btn-primary">OK</button>
        </div>
    </div>
    
    <!-- Modal de Opções de Adição -->
    <div id="add-options-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Adicionar Alocação</h3>
            <p>Como você deseja adicionar este profissional à escala?</p>
            <div class="modal-buttons">
                <button id="add-once-btn" class="btn-primary">Somente neste dia</button>
                <button id="add-recurring-btn" class="btn-secondary">Repetir Semanalmente</button>
                <button class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Opções de Remoção -->
    <div id="remove-options-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Remover Alocação</h3>
            <p>Esta é uma alocação recorrente. Como você deseja removê-la?</p>
            <div class="modal-buttons">
                <button id="remove-once-btn" class="btn-primary">Remover somente este dia</button>
                <button id="remove-future-btn" class="btn-secondary">Remover desta e das futuras</button>
                <button id="remove-all-btn" class="btn-danger">Remover todas as ocorrências</button>
                <button class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>


<script>
// --- MOCK DATA ---
const initialRecurringTemplate = [
    { recurringId: 'rec1', unidade: "Angra", sala: "CONS 01", dayOfWeek: 1, periodo: "Manhã", especialidade: "GASTROENTEROLOGIA", profissional_nome: "LEANDRO VIEIRA" },
    { recurringId: 'rec2', unidade: "Angra", sala: "CONS 02", dayOfWeek: 1, periodo: "Manhã", especialidade: "ORTOPEDIA", profissional_nome: "RODRIGO BASTOS" },
    { recurringId: 'rec3', unidade: "Bangu", sala: "CONS 02", dayOfWeek: 2, periodo: "Manhã", especialidade: "DERMATOLOGIA", profissional_nome: "DAYSE DERMATO" },
    { recurringId: 'rec4', unidade: "Barra", sala: "CONS 04", dayOfWeek: 1, periodo: "Manhã", especialidade: "ANGIOLOGIA", profissional_nome: "MONICA" },
];

let allProfessionals = [
    { nome: "LEANDRO VIEIRA", especialidade: "GASTROENTEROLOGIA", telefone: "(21) 98877-6655" }, 
    { nome: "RODRIGO BASTOS", especialidade: "ORTOPEDIA", telefone: "(21) 91122-3344" },
    { nome: "PEDRO PAULO", especialidade: "OTORRINOLARINGOLOGIA", telefone: "(21) 95566-7788" },
    { nome: "JULIANA RIBEIRO", especialidade: "GINECOLOGIA", telefone: "(21) 98888-9999" },
    { nome: "CAMILA MAIA", especialidade: "DERMATOLOGIA", telefone: "(21) 97777-6666" },
    { nome: "RAPHAEL CATRAMBY", especialidade: "UROLOGIA", telefone: "(21) 96666-5555" },
    { nome: "ALEXANDRE RAMOS", especialidade: "ORTOPEDIA", telefone: "(21) 95555-4444" },
    { nome: "THIAGO COSTA", especialidade: "UROLOGIA", telefone: "(21) 94444-3333" },
    { nome: "DAYSE DERMATO", especialidade: "DERMATOLOGIA", telefone: "(21) 93333-2222" },
    { nome: "CLAUDIA ANECHINO", especialidade: "CARDIOLOGIA", telefone: "(21) 92222-1111" },
];

// --- APP STATE ---
let unitsAndRooms = {};
let scheduleData = []; // Agora armazena eventos com datas específicas
let currentDate = new Date('2025-07-15T12:00:00'); 
let draggedItem = null;
let itemProcessingContext = null; // Guarda contexto para modais

// --- DOM ELEMENTS ---
const loginPage = document.getElementById('login-page');
const appPage = document.getElementById('app-page');
const loginGestorBtn = document.getElementById('login-gestor');
const loginColaboradorBtn = document.getElementById('login-colaborador');
const scheduleGrid = document.getElementById('schedule-grid');
const doctorsPanel = document.getElementById('doctors-panel');
const unitFilter = document.getElementById('unit-filter');
const specialtyFilterSidebar = document.getElementById('specialty-filter-sidebar');
const prevWeekBtn = document.getElementById('prev-week');
const nextWeekBtn = document.getElementById('next-week');
const currentWeekDisplay = document.getElementById('current-week-display');
const removeZone = document.getElementById('remove-zone');
const notificationModal = document.getElementById('notification-modal');
const notificationMessage = document.getElementById('notification-message');
const notificationCloseBtn = document.getElementById('notification-close');
const addOptionsModal = document.getElementById('add-options-modal');
const removeOptionsModal = document.getElementById('remove-options-modal');
const tabs = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');
const registrationForm = document.getElementById('registration-form');
const professionalsTableBody = document.getElementById('professionals-table-body');
const fullScheduleTableBody = document.getElementById('full-schedule-table-body');
const scheduleControls = document.getElementById('schedule-controls');
const mainTitle = document.querySelector('.main-title');
const exportCsvBtn = document.getElementById('export-csv-btn');
const importCsvBtn = document.getElementById('import-csv-btn');
const csvImportInput = document.getElementById('csv-import-input');
const addUnitForm = document.getElementById('add-unit-form');
const unitsContainer = document.getElementById('units-container');


// --- UTILS ---
function getWeekDays(date) {
    const startOfWeek = new Date(date);
    startOfWeek.setHours(0, 0, 0, 0);
    startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() === 0 ? 6 : startOfWeek.getDay() - 1));
    const week = [];
    for (let i = 0; i < 6; i++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        week.push(day);
    }
    return week;
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function showNotification(message) {
    notificationMessage.textContent = message;
    notificationModal.classList.remove('hidden');
}

// --- DATA GENERATION ---
function initializeUnitsAndRooms() {
    unitsAndRooms = initialRecurringTemplate.reduce((acc, item) => {
        if (!acc[item.unidade]) {
            acc[item.unidade] = [];
        }
        if (!acc[item.unidade].includes(item.sala)) {
            acc[item.unidade].push(item.sala);
        }
        return acc;
    }, {});
}

function generateInitialSchedule() {
    scheduleData = [];
    const today = new Date();
    today.setHours(0,0,0,0);

    initialRecurringTemplate.forEach(template => {
        for (let i = -26; i < 26; i++) {
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + (i * 7));
            const dayIndex = template.dayOfWeek === 0 ? 6 : template.dayOfWeek - 1;
            const targetDate = getWeekDays(weekStart)[dayIndex];
            
            if (targetDate) {
                 scheduleData.push({
                    id_escala: `${template.recurringId}-${formatDate(targetDate)}`,
                    recurringId: template.recurringId,
                    date: formatDate(targetDate),
                    unidade: template.unidade,
                    sala: template.sala,
                    periodo: template.periodo,
                    especialidade: template.especialidade,
                    profissional_nome: template.profissional_nome,
                });
            }
        }
    });
}


// --- RENDER FUNCTIONS ---
function render() {
    renderWeekHeader();
    renderScheduleGrid();
    renderDoctorsPanel();
    renderProfessionalsTable();
    renderFullScheduleTable();
    renderUnitsPanel();
}

function renderWeekHeader() {
    const week = getWeekDays(currentDate);
    const start = week[0];
    const end = week[5];
    currentWeekDisplay.textContent = `Semana: ${start.toLocaleDateString('pt-BR')} - ${end.toLocaleDateString('pt-BR')}`;
}

function populateFilters() {
    unitFilter.innerHTML = '<option value="all">Todas</option>';
    specialtyFilterSidebar.innerHTML = '<option value="all">Todas Especialidades</option>';

    const units = Object.keys(unitsAndRooms).sort();
    const specialties = [...new Set(allProfessionals.map(item => item.especialidade))].sort();

    units.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        unitFilter.appendChild(option);
    });

    specialties.forEach(specialty => {
        const option = document.createElement('option');
        option.value = specialty;
        option.textContent = specialty;
        specialtyFilterSidebar.appendChild(option);
    });
}

function renderDoctorsPanel() {
    const specialtyFilter = specialtyFilterSidebar.value;
    const filteredProfessionals = specialtyFilter === 'all'
        ? allProfessionals
        : allProfessionals.filter(p => p.especialidade === specialtyFilter);

    doctorsPanel.innerHTML = '';
    if (filteredProfessionals.length === 0) {
        doctorsPanel.innerHTML = `<p style="color: var(--gray-500); font-size: 0.875rem;">Nenhum profissional cadastrado.</p>`;
    } else {
        filteredProfessionals.forEach(prof => {
            const div = document.createElement('div');
            div.className = 'draggable';
            div.draggable = true;
            div.dataset.professional = JSON.stringify(prof);
            div.innerHTML = `
                <p>${prof.nome}</p>
                <p>${prof.especialidade}</p>
            `;
            doctorsPanel.appendChild(div);
        });
    }
}

function renderScheduleGrid() {
    scheduleGrid.innerHTML = '';
    const week = getWeekDays(currentDate);
    const daysOfWeek = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

    const header = document.createElement('div');
    header.className = 'grid-header contents';
    header.innerHTML = `
        <div>Unidade</div>
        <div>Sala / Período</div>
        ${week.map((day, i) => `<div>${daysOfWeek[i]}<br>${day.getDate()}/${day.getMonth()+1}</div>`).join('')}
    `;
    scheduleGrid.appendChild(header);
    
    const filteredUnit = unitFilter.value;
    const unitsToRender = filteredUnit === 'all' ? Object.keys(unitsAndRooms).sort() : (unitsAndRooms[filteredUnit] ? [filteredUnit] : []);

    unitsToRender.forEach(unit => {
        const rooms = unitsAndRooms[unit] || [];
        rooms.forEach(room => {
            ['Manhã', 'Tarde'].forEach(period => {
                const row = document.createElement('div');
                row.className = 'contents';
                
                row.innerHTML += `
                    <div class="unit-header">${unit}</div>
                    <div class="period-header">
                        <p>${room}</p>
                        <p class="period-text">${period}</p>
                    </div>
                `;

                week.forEach(day => {
                    const dateStr = formatDate(day);
                    const scheduleItem = scheduleData.find(s => 
                        s.date === dateStr && s.unidade === unit && s.sala === room && s.periodo === period
                    );
                    
                    const cell = document.createElement('div');
                    cell.className = 'drop-zone';
                    cell.dataset.date = dateStr; 
                    cell.dataset.unit = unit;
                    cell.dataset.room = room;
                    cell.dataset.period = period;

                    if (scheduleItem) {
                        cell.innerHTML = `
                            <div class="draggable allocated-slot" draggable="true" data-schedule-id="${scheduleItem.id_escala}">
                                <p>${scheduleItem.profissional_nome}</p>
                                <p>${scheduleItem.especialidade}</p>
                            </div>
                        `;
                    } else {
                        cell.innerHTML = `<div class="empty-slot">Vago</div>`;
                    }
                    row.appendChild(cell);
                });
                scheduleGrid.appendChild(row);
            });
        });
    });
}

function renderProfessionalsTable() {
    professionalsTableBody.innerHTML = '';
    allProfessionals.forEach(prof => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${prof.nome}</td>
            <td>${prof.especialidade}</td>
            <td>${prof.telefone || 'N/A'}</td>
        `;
        professionalsTableBody.appendChild(row);
    });
}

function renderFullScheduleTable() {
    fullScheduleTableBody.innerHTML = '';
    const sortedData = [...scheduleData].sort((a, b) => new Date(a.date) - new Date(b.date) || a.unidade.localeCompare(b.unidade));
    sortedData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id_escala}</td>
            <td>${item.recurringId || 'N/A'}</td>
            <td>${item.date}</td>
            <td>${item.unidade}</td>
            <td>${item.sala}</td>
            <td>${item.periodo}</td>
            <td>${item.profissional_nome}</td>
            <td>${item.especialidade}</td>
        `;
        fullScheduleTableBody.appendChild(row);
    });
}

function renderUnitsPanel() {
    unitsContainer.innerHTML = '';
    Object.keys(unitsAndRooms).sort().forEach(unitName => {
        const card = document.createElement('div');
        card.className = 'unit-card';
        
        let roomsHTML = unitsAndRooms[unitName].map(roomName => `
            <li class="room-list-item">
                <span>${roomName}</span>
                <button class="btn-remove remove-room-btn" data-unit="${unitName}" data-room="${roomName}">&times;</button>
            </li>
        `).join('');

        card.innerHTML = `
            <div class="unit-card-header">
                <h4>${unitName}</h4>
                <button class="btn-remove remove-unit-btn" data-unit="${unitName}">&times; Remover Unidade</button>
            </div>
            <ul class="room-list">${roomsHTML}</ul>
            <form class="add-room-form" data-unit="${unitName}">
                <input type="text" placeholder="Nova sala" required class="new-room-input">
                <button type="submit" class="btn">+</button>
            </form>
        `;
        unitsContainer.appendChild(card);
    });
    
    // Add event listeners after rendering
    document.querySelectorAll('.remove-room-btn').forEach(btn => btn.addEventListener('click', handleRemoveRoom));
    document.querySelectorAll('.remove-unit-btn').forEach(btn => btn.addEventListener('click', handleRemoveUnit));
    document.querySelectorAll('.add-room-form').forEach(form => form.addEventListener('submit', handleAddRoom));
}

// --- EVENT HANDLERS & LOGIC ---
function handleDragStart(e) {
    if (e.target.classList.contains('draggable')) {
        e.target.classList.add('dragging');
        draggedItem = e.target;
    }
}

function handleDragEnd(e) {
    if (e.target.classList.contains('draggable')) {
        e.target.classList.remove('dragging');
        draggedItem = null;
    }
}

function handleDragOver(e) {
    e.preventDefault();
    const dropZone = e.target.closest('.drop-zone, #remove-zone');
    if (dropZone) {
        dropZone.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const dropZone = e.target.closest('.drop-zone, #remove-zone');
    if (dropZone) {
        dropZone.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    const dropZone = e.target.closest('.drop-zone, #remove-zone');
    if (!dropZone || !draggedItem) return;

    dropZone.classList.remove('drag-over');

    // REMOVAL LOGIC
    if (dropZone.id === 'remove-zone') {
        const scheduleId = draggedItem.dataset.scheduleId;
        if (scheduleId) {
            const itemToRemove = scheduleData.find(s => s.id_escala === scheduleId);
            if (!itemToRemove) return;
            
            itemProcessingContext = { item: itemToRemove };
            
            if(itemToRemove.recurringId) {
                removeOptionsModal.classList.remove('hidden');
            } else {
                if(confirm(`Tem certeza que deseja remover a alocação de ${itemToRemove.profissional_nome} neste dia?`)) {
                    scheduleData = scheduleData.filter(s => s.id_escala !== scheduleId);
                    render();
                }
            }
        }
        return;
    }

    // ADDITION LOGIC
    const targetSlotData = dropZone.dataset;
    const isOccupied = dropZone.querySelector('.draggable');

    if (isOccupied) {
        showNotification("Este horário já está ocupado. Mova o profissional atual antes de alocar um novo.");
        return;
    }
    
    if (draggedItem.dataset.professional) {
        itemProcessingContext = {
            professional: JSON.parse(draggedItem.dataset.professional),
            slot: targetSlotData
        };
        addOptionsModal.classList.remove('hidden');
    } else if (draggedItem.dataset.scheduleId) {
        // MOVING LOGIC
        const scheduleId = draggedItem.dataset.scheduleId;
        const itemToMove = scheduleData.find(s => s.id_escala === scheduleId);
        if (itemToMove) {
            scheduleData = scheduleData.filter(s => s.id_escala !== scheduleId);
            const newEntry = { 
                profissional_nome: itemToMove.profissional_nome,
                especialidade: itemToMove.especialidade,
                date: targetSlotData.date,
                unidade: targetSlotData.unit,
                sala: targetSlotData.room,
                periodo: targetSlotData.period,
                id_escala: `moved-${Date.now()}`, 
                recurringId: null 
            };
            scheduleData.push(newEntry);
            showNotification(`${itemToMove.profissional_nome} movido para o novo horário (apenas este dia).`);
            render();
        }
    }
}

function handleTabClick(e) {
    const clickedTab = e.target;
    tabs.forEach(tab => tab.classList.remove('active'));
    clickedTab.classList.add('active');

    const targetPanelId = clickedTab.dataset.tab;
    tabContents.forEach(panel => {
        if (panel.id === targetPanelId) {
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
        }
    });

    if (targetPanelId === 'schedule-panel') {
        scheduleControls.classList.remove('hidden');
        mainTitle.textContent = "Painel de Gestão de Escalas";
    } else {
        scheduleControls.classList.add('hidden');
        mainTitle.textContent = "Painel de Gestão";
    }
}

function handleAddProfessional(e) {
    e.preventDefault();
    const nameInput = document.getElementById('prof-name');
    const specialtyInput = document.getElementById('prof-specialty');
    const phoneInput = document.getElementById('prof-phone');
    
    const name = nameInput.value.trim();
    const specialty = specialtyInput.value.trim();
    const phone = phoneInput.value.trim();

    if (name && specialty) {
        if (allProfessionals.some(p => p.nome.toLowerCase() === name.toLowerCase())) {
            showNotification(`Profissional "${name}" já existe.`);
            return;
        }
        
        allProfessionals.push({ nome: name, especialidade: specialty, telefone: phone });
        showNotification(`Profissional ${name} cadastrado com sucesso!`);
        registrationForm.reset();
        render();
    } else {
        showNotification("Por favor, preencha nome e especialidade.");
    }
}

// --- MODAL HANDLERS ---
function setupModalHandlers() {
    // Add options modal
    document.getElementById('add-once-btn').addEventListener('click', () => {
        const { professional, slot } = itemProcessingContext;
        scheduleData.push({
            id_escala: `one-time-${Date.now()}`,
            recurringId: null,
            date: slot.date,
            unidade: slot.unit,
            sala: slot.room,
            periodo: slot.period,
            profissional_nome: professional.nome,
            especialidade: professional.especialidade
        });
        addOptionsModal.classList.add('hidden');
        render();
    });

    document.getElementById('add-recurring-btn').addEventListener('click', () => {
        const { professional, slot } = itemProcessingContext;
        const recurringId = `rec-${Date.now()}`;
        const targetDate = new Date(`${slot.date}T12:00:00`);
        const dayOfWeek = targetDate.getDay(); // 0 for Sun, 1 for Mon...

        for (let i = -52; i < 52; i++) { // 2 years of data
            const weekStartForLoop = new Date(targetDate);
            weekStartForLoop.setDate(targetDate.getDate() + (i * 7));
            const newDate = getWeekDays(weekStartForLoop)[dayOfWeek === 0 ? 6 : dayOfWeek - 1];

            if (newDate) {
                 scheduleData.push({
                    id_escala: `${recurringId}-${formatDate(newDate)}`,
                    recurringId: recurringId,
                    date: formatDate(newDate),
                    unidade: slot.unit,
                    sala: slot.room,
                    periodo: slot.period,
                    profissional_nome: professional.nome,
                    especialidade: professional.especialidade
                });
            }
        }
        addOptionsModal.classList.add('hidden');
        render();
    });

    // Remove options modal
    document.getElementById('remove-once-btn').addEventListener('click', () => {
        const { item } = itemProcessingContext;
        scheduleData = scheduleData.filter(s => s.id_escala !== item.id_escala);
        removeOptionsModal.classList.add('hidden');
        render();
    });

    document.getElementById('remove-future-btn').addEventListener('click', () => {
        const { item } = itemProcessingContext;
        const itemDate = new Date(`${item.date}T12:00:00`);
        scheduleData = scheduleData.filter(s => {
            if (s.recurringId !== item.recurringId) return true;
            const sDate = new Date(`${s.date}T12:00:00`);
            return sDate < itemDate;
        });
        removeOptionsModal.classList.add('hidden');
        render();
    });

    document.getElementById('remove-all-btn').addEventListener('click', () => {
        const { item } = itemProcessingContext;
        scheduleData = scheduleData.filter(s => s.recurringId !== item.recurringId);
        removeOptionsModal.classList.add('hidden');
        render();
    });

    // Cancel buttons
    document.querySelectorAll('.btn-cancel').forEach(btn => {
        btn.addEventListener('click', () => {
            addOptionsModal.classList.add('hidden');
            removeOptionsModal.classList.add('hidden');
        });
    });
}

// --- DATA MANAGEMENT ---
function exportToCSV() {
    if (scheduleData.length === 0) {
        showNotification("Não há dados para exportar.");
        return;
    }
    const headers = Object.keys(scheduleData[0]);
    const csvRows = [headers.join(',')];

    scheduleData.forEach(row => {
        const values = headers.map(header => {
            const escaped = ('' + row[header]).replace(/"/g, '""');
            return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
    });

    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `escala_medica_${formatDate(new Date())}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n');
        const headers = rows[0].trim().split(',').map(h => h.replace(/"/g, ''));

        try {
            const importedData = rows.slice(1).map(rowStr => {
                if (rowStr.trim() === '') return null;
                const values = rowStr.trim().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Split by comma, respecting quotes
                const rowObj = headers.reduce((obj, header, index) => {
                    obj[header] = values[index] ? values[index].replace(/"/g, '') : '';
                    return obj;
                }, {});
                return rowObj;
            }).filter(Boolean);

            scheduleData = importedData;
            initializeUnitsAndRooms(); // Re-initialize units based on new data
            populateFilters();
            render();
            showNotification("Dados importados com sucesso!");
        } catch (error) {
            showNotification("Erro ao processar o arquivo CSV. Verifique o formato.");
            console.error(error);
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset input
}

// --- UNIT MANAGEMENT ---
function handleAddUnit(e) {
    e.preventDefault();
    const unitNameInput = document.getElementById('unit-name');
    const roomNameInput = document.getElementById('initial-room-name');
    const unitName = unitNameInput.value.trim();
    const roomName = roomNameInput.value.trim();

    if (unitName && roomName) {
        if (unitsAndRooms[unitName]) {
            showNotification(`Unidade "${unitName}" já existe.`);
            return;
        }
        unitsAndRooms[unitName] = [roomName];
        addUnitForm.reset();
        populateFilters();
        render();
    } else {
        showNotification("Por favor, preencha todos os campos.");
    }
}

function handleAddRoom(e) {
    e.preventDefault();
    const unitName = e.target.dataset.unit;
    const roomNameInput = e.target.querySelector('.new-room-input');
    const roomName = roomNameInput.value.trim();

    if (roomName) {
        if (unitsAndRooms[unitName].includes(roomName)) {
            showNotification(`Sala "${roomName}" já existe na unidade ${unitName}.`);
            return;
        }
        unitsAndRooms[unitName].push(roomName);
        roomNameInput.value = '';
        render();
    }
}

function handleRemoveRoom(e) {
    const { unit, room } = e.target.dataset;
    const isInUse = scheduleData.some(item => item.unidade === unit && item.sala === room);
    
    let confirmation = true;
    if (isInUse) {
        confirmation = confirm(`ATENÇÃO: A sala "${room}" está em uso. Remover a sala também removerá todas as alocações associadas. Deseja continuar?`);
    }
    
    if (confirmation) {
        unitsAndRooms[unit] = unitsAndRooms[unit].filter(r => r !== room);
        scheduleData = scheduleData.filter(item => !(item.unidade === unit && item.sala === room));
        render();
    }
}

function handleRemoveUnit(e) {
    const { unit } = e.target.dataset;
    const isInUse = scheduleData.some(item => item.unidade === unit);

    let confirmation = true;
    if (isInUse) {
        confirmation = confirm(`ATENÇÃO: A unidade "${unit}" está em uso. Remover a unidade também removerá todas as suas salas e alocações associadas. Deseja continuar?`);
    }

    if (confirmation) {
        delete unitsAndRooms[unit];
        scheduleData = scheduleData.filter(item => item.unidade !== unit);
        populateFilters();
        render();
    }
}

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loginGestorBtn.addEventListener('click', () => {
        loginPage.classList.add('hidden');
        appPage.classList.remove('hidden');
        initializeApp();
    });
    loginColaboradorBtn.addEventListener('click', () => {
        showNotification("O portal do colaborador está em desenvolvimento.");
    });
    notificationCloseBtn.addEventListener('click', () => {
        notificationModal.classList.add('hidden');
    });

    function initializeApp() {
        initializeUnitsAndRooms();
        generateInitialSchedule();
        populateFilters();
        render();
        setupModalHandlers();

        prevWeekBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 7);
            render();
        });
        nextWeekBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 7);
            render();
        });
        unitFilter.addEventListener('change', renderScheduleGrid);
        specialtyFilterSidebar.addEventListener('change', renderDoctorsPanel);

        tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
        registrationForm.addEventListener('submit', handleAddProfessional);
        exportCsvBtn.addEventListener('click', exportToCSV);
        importCsvBtn.addEventListener('click', () => csvImportInput.click());
        csvImportInput.addEventListener('change', importFromCSV);
        addUnitForm.addEventListener('submit', handleAddUnit);

        document.addEventListener('dragstart', handleDragStart);
        document.addEventListener('dragend', handleDragEnd);
        document.addEventListener('dragover', handleDragOver);
        document.addEventListener('dragleave', handleDragLeave);
        document.addEventListener('drop', handleDrop);
    }
});
</script>
</body>
</html>
